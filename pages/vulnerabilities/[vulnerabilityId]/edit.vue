<script lang="ts" setup>
import { useToast } from "vue-toastification";
import { useVulnerabilitiesStore } from "~/stores/useVulnerabilitiesStore";

definePageMeta({
  middleware: ["auth"],
});

const errors = ref("");
const errorMessage = ref("");
const config = useRuntimeConfig();
const route = useRoute();
const toast = useToast();
const vulnerabilityId = route.params.vulnerabilityId;
const vulnerabilitiesStore = useVulnerabilitiesStore();

const form = ref({
  code: "",
  title: "",
  overview: "",
  description: "",
  image_url: "",
  user_id: "",
});

const fetchData = async (id) => {
  const { data: vulnerability, error } = await vulnerabilitiesStore.show(id);

  if (error.value) {
    toast.error("An error occurred fetching the data.");
    return;
  }

  form.value.code = vulnerability.value.code;
  form.value.title = vulnerability.value.title;
  form.value.overview = vulnerability.value.overview;
  form.value.description = vulnerability.value.description;
  form.value.image_url = vulnerability.value.image_url;
  form.value.user_id = vulnerability.value.user.id;
};

fetchData(vulnerabilityId);

const handleVulnerabilityUpdate = async () => {
  const { error } = await vulnerabilitiesStore.update(
    vulnerabilityId,
    form.value,
  );

  if (error.value) {
    console.log(error);

    errors.value = error.value.data?.errors ?? "";
    errorMessage.value = error.value.data?.message ?? "";
    toast.error("An error occurred fetching the data.");
    return;
  }

  errors.value = "";
  errorMessage.value = "";
  toast.success("Vulnerability Updated Successfully");
};
</script>

<template>
  <div class="mt-8 flex justify-center items-center">
    <form
      class="w-full mx-8 md:w-1/2"
      @submit.prevent="handleVulnerabilityUpdate"
    >
      <h2 class="text-3xl font-bold text-center leading-7 text-white">
        Vulnerability
      </h2>

      <TextInput
        id="code"
        v-model:value="form.code"
        class="mt-4 block w-full"
        label="Code"
        name="code"
        type="text"
        :error="errors?.code ? errors.code[0] : ''"
      />

      <TextInput
        id="title"
        v-model:value="form.title"
        class="mt-4 block w-full"
        label="Title"
        name="title"
        type="text"
        :error="errors?.title ? errors.title[0] : ''"
      />

      <TextArea
        id="overview"
        v-model:value="form.overview"
        class="mt-4 block w-full"
        label="Overview"
        name="overview"
        :error="errors?.overview ? errors.overview[0] : ''"
      />

      <TextArea
        id="description"
        v-model:value="form.description"
        class="mt-4 block w-full"
        label="Description"
        name="description"
        :error="errors?.description ? errors.description[0] : ''"
      />

      <div v-if="errorMessage !== ''" class="text-red-500 text-sm mt-2">
        {{ errorMessage }}
      </div>

      <PrimaryButton class="mt-8 block w-full"> Save </PrimaryButton>
    </form>
  </div>
</template>
