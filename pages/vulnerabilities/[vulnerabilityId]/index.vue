<script lang="ts" setup>
import { useToast } from "vue-toastification";
import { useModal } from "vue-final-modal";
import { useVulnerabilitiesStore } from "~/stores/useVulnerabilitiesStore";
import { useAuthStore } from "~/stores/useAuthStore";
import { navigateTo } from "#app";
import SimpleModal from "~/components/SimpleModal.vue";

definePageMeta({
  middleware: ["auth"],
});

const config = useRuntimeConfig();
const auth = useAuthStore();
const route = useRoute();
const toast = useToast();
const vulnerabilityId = route.params.vulnerabilityId;
const vulnerabilitiesStore = useVulnerabilitiesStore();
const vulnerability = ref(null);
const { open, close } = useModal({
  component: SimpleModal,
  attrs: {
    title: "Hello World!",
    onConfirm(value) {
      if (value) {
        handleDelete();
      }

      close();
    },
  },
  slots: {
    default: "<p>UseModal: The content of the modal</p>",
  },
});

const fetchData = async () => {
  const { data, error } = await vulnerabilitiesStore.show(vulnerabilityId);

  if (error.value) {
    toast.error("An error occurred fetching the data.");
    return;
  }

  vulnerability.value = data.value;
};

fetchData();

const handleDelete = async () => {
  if (!auth.user.isAdmin) return;

  const { error } = await vulnerabilitiesStore.destroy(vulnerabilityId);

  if (error.value) {
    console.log(error);
    toast.error("An error occurred while deleting this vulnerability.");
    return;
  }

  return navigateTo("/vulnerabilities");
};
</script>

<template>
  <div class="mt-8">
    <h2 class="text-3xl font-bold text-center leading-7 text-white">
      Vulnerabilities
    </h2>

    <div v-if="vulnerability !== null" class="w-full">
      <div
        class="m-8 overflow-hidden border border-[#AFE613] shadow rounded-lg"
      >
        <div class="border-t border-[#AFE613]">
          <dl class="divide-y divide-[#AFE613]">
            <div class="px-4 py-6 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-white">Image</dt>
              <dd
                class="mt-1 text-sm leading-6 text-gray-200 sm:col-span-5 sm:mt-0"
              >
                <img
                  :src="config.public.api_url + vulnerability.image_url"
                  alt="Vulnerability Logo"
                  class="w-12 h-12"
                />
              </dd>
            </div>

            <div class="px-4 py-6 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-white">Code</dt>
              <dd
                class="mt-1 text-sm leading-6 text-gray-200 sm:col-span-5 sm:mt-0"
              >
                {{ vulnerability.code }}
              </dd>
            </div>

            <div class="px-4 py-6 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-white">Title</dt>
              <dd
                class="mt-1 text-sm leading-6 text-gray-300 sm:col-span-5 sm:mt-0"
              >
                {{ vulnerability.title }}
              </dd>
            </div>

            <div class="px-4 py-6 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-white">Overview</dt>
              <dd
                class="mt-1 text-sm leading-6 text-gray-300 sm:col-span-5 sm:mt-0"
              >
                {{ vulnerability.overview }}
              </dd>
            </div>

            <div class="px-4 py-6 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-white">Description</dt>
              <dd
                class="mt-1 text-sm leading-6 text-gray-300 sm:col-span-5 sm:mt-0"
              >
                {{ vulnerability.description }}
              </dd>
            </div>

            <div class="px-4 py-6 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-white">Created by</dt>
              <dd
                class="mt-1 text-sm leading-6 text-gray-300 sm:col-span-5 sm:mt-0"
              >
                {{ vulnerability.user.name }}
              </dd>
            </div>
          </dl>
        </div>
      </div>

      <div v-if="auth.user.isAdmin" class="mx-8 flex">
        <CustomLink
          class="mr-2 w-1/2 block"
          :to="`/vulnerabilities/${vulnerabilityId}/edit`"
        >
          Edit
        </CustomLink>

        <PrimaryButton class="w-1/2 block" @click="open">
          Delete
        </PrimaryButton>
      </div>
    </div>

    <div v-else class="m-8 text-2xl text-center text-red-500">
      Fetching data...
    </div>
  </div>
</template>
